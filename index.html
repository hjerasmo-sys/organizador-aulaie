<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Aula</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* shadow-lg */
            padding: 2.5rem; /* p-10 */
            width: 100%;
            max-width: 960px; /* max-w-4xl */
        }
        .input-group label {
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.5rem; /* mb-2 */
            display: block;
            color: #334155; /* slate-700 */
        }
        .input-group input[type="number"],
        .input-group input[type="file"],
        .input-group select { /* Added select for styling */
            width: 100%;
            padding: 0.75rem 1rem; /* py-3 px-4 */
            border: 1px solid #cbd5e1; /* border-slate-300 */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1rem; /* text-base */
            color: #334155; /* slate-700 */
            transition: all 0.2s ease-in-out;
            background-color: #ffffff; /* Ensure select background is white */
        }
        .input-group input[type="number"]:focus,
        .input-group input[type="file"]:focus,
        .input-group select:focus { /* Added select for styling */
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* ring-indigo-200 */
        }
        .button-primary {
            background-image: linear-gradient(to right, #6366f1, #8b5cf6); /* Gradient from indigo-500 to violet-500 */
            color: #ffffff;
            font-weight: 700; /* font-bold */
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.75rem; /* rounded-xl */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
        }
        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); /* Slightly larger shadow on hover */
        }
        .grid-container {
            display: grid;
            gap: 1rem; /* gap-4 */
            margin-top: 2rem; /* mt-8 */
            padding: 1rem;
            background-color: #f8fafc; /* slate-50 */
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px dashed #cbd5e1; /* border-slate-300 */
            overflow-x: auto; /* Enable horizontal scrolling for wide grids */
        }
        .seat {
            background-color: #e0e7ff; /* indigo-100 */
            border: 1px solid #a5b4fc; /* indigo-300 */
            border-top: 5px solid #6366f1; /* Darker top border for desk effect */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 0.5rem; /* p-2 */
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.9rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #4338ca; /* indigo-700 */
            min-width: 100px; /* Minimum width for seats */
            aspect-ratio: 1.2 / 1; /* Make seats slightly rectangular for desk effect */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .seat-input {
            width: 100%;
            height: 100%;
            border: none;
            background-color: transparent;
            text-align: center;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4338ca;
            padding: 0;
            outline: none;
        }
        .message-box {
            background-color: #fee2e2; /* red-100 */
            border: 1px solid #ef4444; /* red-500 */
            color: #dc2626; /* red-600 */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none; /* Hidden by default */
        }
        .message-box.show {
            display: block;
        }
        .message-box button {
            background: none;
            border: none;
            color: #dc2626;
            font-weight: bold;
            float: right;
            cursor: pointer;
        }
        .user-id-display {
            font-size: 0.8rem;
            color: #64748b; /* slate-500 */
            text-align: center;
            margin-top: 1rem;
            word-break: break-all; /* Ensures long IDs wrap */
        }
        .board {
            background-color: #334155; /* slate-700 */
            color: #ffffff;
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            margin-top: 2rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%; /* Adjust width as needed */
            max-width: 600px; /* Max width for larger screens */
            align-self: center; /* Center horizontally in a flex container */
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-extrabold text-center text-slate-800 mb-8">Organizador de Aula ✨</h1>

        <div class="message-box" id="messageBox">
            <button onclick="document.getElementById('messageBox').classList.remove('show')">&times;</button>
            <span id="messageText"></span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="grid grid-cols-1 gap-6">
                <div class="input-group">
                    <label for="numRows">Número de Filas:</label>
                    <input type="number" id="numRows" value="5" min="1">
                </div>
                <div class="input-group">
                    <label for="numCols">Número de Columnas:</label>
                    <input type="number" id="numCols" value="6" min="1">
                </div>
                <!-- New Grade Selection -->
                <div class="input-group">
                    <label for="gradeSelect">Seleccionar Grado:</label>
                    <select id="gradeSelect">
                        <option value="601">Grado 601</option>
                        <option value="602">Grado 602</option>
                        <option value="603">Grado 603</option>
                        <option value="604">Grado 604</option>
                        <option value="701">Grado 701</option>
                        <option value="702">Grado 702</option>
                        <option value="703">Grado 703</option>
                        <option value="704">Grado 704</option>
                        <option value="801">Grado 801</option>
                        <option value="802">Grado 802</option>
                        <option value="803">Grado 803</option>
                        <option value="901">Grado 901</option>
                        <option value="902">Grado 902</option>
                        <option value="903">Grado 903</option>
                        <option value="1001">Grado 1001</option>
                        <option value="1002">Grado 1002</option>
                        <option value="1101">Grado 1101</option>
                        <option value="1102">Grado 1102</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Board element added here -->
        <div class="board" id="classroomBoard">
            TABLERO
        </div>

        <div id="classroomDiagram" class="grid-container">
            <p class="text-slate-500 italic text-center">Ingresa el número de filas y columnas, selecciona el grado, luego haz clic en "Crear Esquema de Aula" (abajo) para empezar a ubicar a tus estudiantes. El tablero está arriba de la primera fila.</p>
        </div>
        
        <!-- Buttons moved to below the diagram -->
        <div class="flex flex-wrap justify-center md:justify-start gap-4 mt-8">
            <button id="createLayoutBtn" class="button-primary">Crear Esquema de Aula</button>
            <button id="saveLayoutBtn" class="button-primary">Guardar Distribución</button>
            <button id="exportPdfBtn" class="button-primary">Exportar a PDF</button>
            <button id="exportExcelBtn" class="button-primary">Exportar a Excel (CSV)</button>
        </div>
        <div class="input-group mt-6">
            <label for="csvFile">Cargar desde archivo CSV (Exporta tu Excel a CSV primero):</label>
            <input type="file" id="csvFile" accept=".csv">
            <button id="loadCsvBtn" class="button-primary mt-4">Cargar desde CSV</button>
        </div>

        <div id="userIdDisplay" class="user-id-display"></div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales para la configuración de Firebase y el ID de la aplicación.
        // IMPORTANTE: NO modifiques estas variables directamente. El entorno de Canvas
        // las inyectará automáticamente cuando la aplicación se ejecute en él.
        // Si ejecutas este código localmente (fuera del entorno de Canvas), se usará
        // tu configuración de Firebase predeterminada como respaldo.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDf3r2W8GXIxLejU7l8T-AKmfWFwBXB_cs",
            authDomain: "appclases-32445.firebaseapp.com",
            projectId: "appclases-32445",
            storageBucket: "appclases-32445.firebasestorage.app",
            messagingSenderId: "356977293092",
            appId: "1:356977293092:web:c5f6943246f00f3baca5b1"
        };
        
        // __app_id se proporciona por el entorno de Canvas. Usamos projectId de firebaseConfig como respaldo.
        const appIdForFirestore = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        
        // __initial_auth_token se proporciona por el entorno de Canvas. Usamos null como respaldo.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOM content loaded. Starting app initialization and element fetching.");

            const numRowsInput = document.getElementById('numRows');
            const numColsInput = document.getElementById('numCols');
            const gradeSelect = document.getElementById('gradeSelect');
            const createLayoutBtn = document.getElementById('createLayoutBtn');
            const saveLayoutBtn = document.getElementById('saveLayoutBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const csvFileInput = document.getElementById('csvFile');
            const loadCsvBtn = document.getElementById('loadCsvBtn');
            const classroomDiagramDiv = document.getElementById('classroomDiagram');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const userIdDisplay = document.getElementById('userIdDisplay');
            const classroomBoard = document.getElementById('classroomBoard');

            // --- Verificación de elementos DOM ---
            const elementsToCheck = {
                'numRowsInput': numRowsInput,
                'numColsInput': numColsInput,
                'gradeSelect': gradeSelect,
                'createLayoutBtn': createLayoutBtn,
                'saveLayoutBtn': saveLayoutBtn,
                'exportPdfBtn': exportPdfBtn,
                'exportExcelBtn': exportExcelBtn,
                'csvFileInput': csvFileInput,
                'loadCsvBtn': loadCsvBtn,
                'classroomDiagramDiv': classroomDiagramDiv,
                'messageBox': messageBox,
                'messageText': messageText,
                'userIdDisplay': userIdDisplay,
                'classroomBoard': classroomBoard
            };

            for (const id in elementsToCheck) {
                if (!elementsToCheck[id]) {
                    console.error(`Error crítico: El elemento DOM con ID '${id}' no se encontró. Los botones pueden no funcionar.`);
                    showMessage(`Error: El elemento de la interfaz con ID '${id}' no se encontró. La aplicación podría no funcionar correctamente. Revisa el código HTML.`, 'error');
                } else {
                    console.log(`Elemento DOM con ID '${id}' encontrado.`);
                }
            }
            // --- Fin de la verificación de elementos DOM ---


            /**
             * Muestra un mensaje en la caja de mensajes personalizada.
             * @param {string} message - El mensaje a mostrar.
             * @param {'error'|'info'|'success'} type - El tipo de mensaje para determinar el estilo.
             */
            function showMessage(message, type = 'error') {
                messageText.textContent = message;
                messageBox.className = 'message-box show'; // Reiniciar clases y mostrar
                if (type === 'error') {
                    messageBox.style.backgroundColor = '#fee2e2'; // red-100
                    messageBox.style.borderColor = '#ef4444'; // red-500
                    messageBox.style.color = '#dc2626'; // red-600
                } else if (type === 'info') {
                    messageBox.style.backgroundColor = '#d1fae5'; // green-100
                    messageBox.style.borderColor = '#34d399'; // green-400
                    messageBox.style.color = '#065f46'; // green-800
                } else if (type === 'success') {
                    messageBox.style.backgroundColor = '#d1fae5'; /* green-100 */
                    messageBox.style.borderColor = '#34d399'; /* green-400 */
                    messageBox.style.color = '#065f46'; /* green-800 */
                }
            }

            // --- Inicialización y Autenticación de Firebase ---
            try {
                // Inicializar la aplicación de Firebase
                const app = initializeApp(firebaseConfig);
                
                // Obtener instancias de Auth y Firestore
                auth = getAuth(app);
                db = getFirestore(app);

                console.log('Firebase App initialized with config:', firebaseConfig);
                console.log('Auth service instance obtained:', auth);
                if (auth && auth.app && auth.app.options) {
                    console.log('Auth service options (from app config):', auth.app.options);
                } else {
                    console.warn('Auth service or its app options not immediately available after getAuth.');
                }

                // Iniciar sesión con token personalizado o de forma anónima si no se proporciona token
                if (initialAuthToken) {
                    console.log('Attempting signInWithCustomToken...');
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log('Attempting signInAnonymously...');
                    await signInAnonymously(auth);
                }
                console.log('Authentication attempt completed.');


                // Escuchar los cambios en el estado de autenticación
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Tu ID de usuario: ${userId}`;
                        isAuthReady = true;
                        console.log('User authenticated. UID:', userId);
                        // Cargar el diseño una vez autenticado
                        loadLayoutForSelectedGrade();
                    } else {
                        userId = null;
                        userIdDisplay.textContent = 'No autenticado.';
                        isAuthReady = false;
                        console.log('User not authenticated.');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                if (error.code === 'auth/configuration-not-found') {
                    showMessage("Error de Firebase: La configuración de autenticación no se encontró. Esto **NO es un error de código**, es un problema en la **configuración de tu proyecto en la Consola de Firebase**. Por favor, asegúrate de que el método de inicio de sesión **'Anónimo' esté HABILITADO** en la sección 'Authentication' de tu proyecto.", 'error');
                } else if (error.code === 'auth/network-request-failed') {
                    showMessage("Error de Firebase: Falló la conexión de red. Por favor, verifica tu conexión a Internet.", 'error');
                } else {
                    showMessage("Error al iniciar la aplicación. Por favor, inténtalo de nuevo más tarde. Detalles: " + error.message, 'error');
                }
            }

            // Listener de evento para el cambio de selección de grado
            gradeSelect.addEventListener('change', loadLayoutForSelectedGrade);

            /**
             * Obtiene la referencia del documento de Firestore para el diseño de un grado específico.
             * Utiliza la ruta de datos públicos para el acceso colaborativo.
             * @param {string} gradeId - El ID del grado (ej. "601").
             * @returns {DocumentReference} - La referencia del documento de Firestore.
             */
            function getGradeLayoutDocRef(gradeId) {
                // IMPORTANTE: Usando `appIdForFirestore` y colección pública para datos compartidos
                const path = `artifacts/${appIdForFirestore}/public/data/grades/${gradeId}`;
                console.log('Firestore Path for Grade:', path);
                return doc(db, path);
            }

            /**
             * Crea la cuadrícula del diseño del aula basándose en la entrada del usuario para filas y columnas.
             */
            createLayoutBtn.addEventListener('click', () => {
                console.log("Botón 'Crear Esquema de Aula' clicado!");
                const numRows = parseInt(numRowsInput.value);
                const numCols = parseInt(numColsInput.value);

                if (isNaN(numRows) || numRows < 1) {
                    showMessage('Por favor, ingresa un número válido de filas (mínimo 1).', 'error');
                    console.error('Error: Número de filas inválido:', numRows);
                    return;
                }
                if (isNaN(numCols) || numCols < 1) {
                    showMessage('Por favor, ingresa un número válido de columnas (mínimo 1).', 'error');
                    console.error('Error: Número de columnas inválido:', numCols);
                    return;
                }
                console.log(`Creando diseño con ${numRows} filas y ${numCols} columnas.`);


                const totalSeats = numRows * numCols;

                classroomDiagramDiv.innerHTML = '';
                classroomDiagramDiv.style.gridTemplateColumns = `repeat(${numCols}, minmax(100px, 1fr))`;

                for (let i = 0; i < totalSeats; i++) {
                    const seatDiv = document.createElement('div');
                    seatDiv.classList.add('seat');
                    
                    const seatInput = document.createElement('input');
                    seatInput.type = 'text';
                    seatInput.classList.add('seat-input');
                    seatInput.placeholder = `Estudiante ${i + 1}`;
                    seatDiv.appendChild(seatInput);

                    classroomDiagramDiv.appendChild(seatDiv);
                }

                classroomBoard.style.display = 'block'; // Mostrar el tablero cuando se crea el diseño
                showMessage('¡Listo! Ahora puedes escribir el nombre de cada estudiante en su pupitre.', 'info');
            });

            /**
             * Guarda el diseño actual del aula en Firestore para el grado seleccionado.
             */
            saveLayoutBtn.addEventListener('click', async () => {
                console.log("Botón 'Guardar Distribución' clicado!");
                if (!isAuthReady || !userId) {
                    showMessage('Autenticación no lista. Por favor, espera o recarga la página.', 'error');
                    console.warn('Advertencia: Intento de guardar fallido, autenticación no lista o ID de usuario ausente.');
                    return;
                }
                console.log('Autenticación lista. Procediendo a guardar.');


                const selectedGrade = gradeSelect.value;
                if (!selectedGrade) {
                    showMessage('Por favor, selecciona un grado para guardar la distribución.', 'error');
                    return;
                }

                const seatInputs = document.querySelectorAll('.seat-input');
                if (seatInputs.length === 0) {
                    showMessage(`No hay un esquema de aula para guardar en ${selectedGrade}. ¡Crea uno primero!`, 'info');
                    return;
                }

                const numRows = parseInt(numRowsInput.value);
                const numCols = parseInt(numColsInput.value);
                const seatsData = Array.from(seatInputs).map(input => input.value.trim());

                const layoutData = {
                    numRows: numRows,
                    numCols: numCols,
                    seats: seatsData,
                    timestamp: new Date().toISOString() // Almacenar como cadena ISO
                };

                try {
                    const layoutDocRef = getGradeLayoutDocRef(selectedGrade);
                    console.log('Intentando guardar en la ruta de Firestore:', layoutDocRef.path);
                    await setDoc(layoutDocRef, layoutData);
                    showMessage(`¡Distribución de aula guardada con éxito para ${selectedGrade}!`, 'success');
                } catch (error) {
                    console.error("Error al guardar la distribución:", error);
                    showMessage('Error al guardar la distribución. Esto puede deberse a la configuración de las reglas de seguridad de Firestore. Asegúrate de que los usuarios autenticados tengan permisos de escritura para la ruta `artifacts/{projectId}/public/data/grades/{gradeId}`. Por favor, inténtalo de nuevo.', 'error');
                }
            });

            /**
             * Carga el diseño del aula para el grado actualmente seleccionado desde Firestore.
             */
            async function loadLayoutForSelectedGrade() {
                console.log("Función loadLayoutForSelectedGrade llamada.");
                if (!isAuthReady || !userId) {
                    console.log('Carga omitida: Autenticación no lista o userId es nulo.');
                    return;
                }

                const selectedGrade = gradeSelect.value;
                if (!selectedGrade) {
                    showMessage('No hay un grado seleccionado para cargar.', 'info');
                    classroomDiagramDiv.innerHTML = '<p class="text-slate-500 italic text-center">Ingresa el número de filas y columnas, selecciona el grado, luego haz clic en "Crear Esquema de Aula" (abajo) para empezar a ubicar a tus estudiantes. El tablero está arriba de la primera fila.</p>';
                    classroomBoard.style.display = 'none';
                    return;
                }
                console.log(`Intentando cargar el diseño para el grado: ${selectedGrade}`);


                try {
                    const layoutDocRef = getGradeLayoutDocRef(selectedGrade);
                    console.log('Intentando cargar desde la ruta de Firestore:', layoutDocRef.path);
                    const docSnap = await getDoc(layoutDocRef);

                    if (docSnap.exists()) {
                        const savedLayout = docSnap.data();
                        numRowsInput.value = savedLayout.numRows;
                        numColsInput.value = savedLayout.numCols;
                        console.log('Diseño cargado:', savedLayout);

                        // Crear el diseño primero para asegurar que existan los inputs de los asientos
                        createLayoutBtn.click();

                        const seatInputs = document.querySelectorAll('.seat-input');
                        savedLayout.seats.forEach((studentName, index) => {
                            if (seatInputs[index]) {
                                seatInputs[index].value = studentName;
                            }
                        });
                        classroomBoard.style.display = 'block';
                        showMessage(`¡Distribución de aula cargada con éxito para ${selectedGrade}!`, 'success');
                    } else {
                        showMessage(`No se encontró ninguna distribución de aula guardada para ${selectedGrade}.`, 'info');
                        classroomDiagramDiv.innerHTML = '<p class="text-slate-500 italic text-center">Ingresa el número de filas y columnas, selecciona el grado, luego haz clic en "Crear Esquema de Aula" (abajo) para empezar a ubicar a tus estudiantes. El tablero está arriba de la primera fila.</p>';
                        classroomBoard.style.display = 'none';
                    }
                } catch (error) {
                    console.error(`Error al cargar la distribución para ${selectedGrade}:`, error);
                    showMessage('Error al cargar la distribución. Esto puede deberse a la configuración de las reglas de seguridad de Firestore. Asegúrate de que los usuarios autenticados tengan permisos de lectura para la ruta `artifacts/{projectId}/public/data/grades/{gradeId}`. Por favor, inténtalo de nuevo.', 'error');
                }
            }

            /**
             * Exporta el diagrama del aula actual a un documento PDF.
             * Utiliza html2canvas para renderizar el HTML a una imagen, luego jsPDF para crear el PDF.
             */
            exportPdfBtn.addEventListener('click', async () => {
                console.log("Botón 'Exportar a PDF' clicado!");
                const classroomContainerForPdf = document.createElement('div');
                classroomContainerForPdf.style.display = 'flex';
                classroomContainerForPdf.style.flexDirection = 'column';
                classroomContainerForPdf.style.alignItems = 'center';
                classroomContainerForPdf.style.padding = '20px';
                classroomContainerForPdf.style.backgroundColor = '#ffffff'; // Asegurar fondo blanco para PDF
                classroomContainerForPdf.style.boxShadow = 'none'; // Sin sombra para PDF

                // Clonar y añadir el elemento del tablero para el PDF
                const clonedBoard = classroomBoard.cloneNode(true);
                clonedBoard.style.display = 'block';
                clonedBoard.style.width = '80%';
                clonedBoard.style.maxWidth = '600px';
                clonedBoard.style.marginBottom = '2rem';
                classroomContainerForPdf.appendChild(clonedBoard);

                const classroomDiagram = document.getElementById('classroomDiagram');
                // Comprobar si el diagrama contiene solo el párrafo de marcador de posición inicial
                if (classroomDiagram.children.length <= 1 && classroomDiagram.querySelector('p')) {
                    showMessage('No hay un diagrama de aula para exportar a PDF. ¡Crea uno primero!', 'info');
                    return;
                }

                // Ajustar temporalmente el estilo de los inputs y guardar los valores originales para la exportación a PDF
                const seatInputs = document.querySelectorAll('.seat-input');
                const originalValues = [];
                
                seatInputs.forEach(input => {
                    originalValues.push(input.value);
                    // Para PDF, queremos solo el primer nombre o el nombre completo sin estilos de input adicionales
                    input.style.border = 'none';
                    input.style.outline = 'none';
                });

                // Ajustar temporalmente el ancho de la cuadrícula para una mejor renderización de cuadrículas anchas en PDF
                const originalGridWidth = classroomDiagram.style.width;
                classroomDiagram.style.width = `${classroomDiagram.scrollWidth}px`; // Establecer ancho explícito para evitar problemas de desbordamiento

                const clonedDiagram = classroomDiagram.cloneNode(true);
                classroomContainerForPdf.appendChild(clonedDiagram);
                document.body.appendChild(classroomContainerForPdf); // Añadir temporalmente para obtener las dimensiones correctas para html2canvas

                try {
                    showMessage('Generando PDF...', 'info');
                    console.log('Iniciando html2canvas para generar la imagen del PDF.');
                    // Renderizar todo el contenedor a un canvas
                    const canvas = await html2canvas(classroomContainerForPdf, { scale: 2 }); // Aumentar la escala para una mejor resolución
                    const imgData = canvas.toDataURL('image/png');
                    
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' para retrato, 'mm' para milímetros, 'a4' para tamaño A4
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const margin = 10; // Margen de 10 mm en todos los lados
                    const contentWidth = pdfWidth - 2 * margin;

                    const imgHeight = (canvas.height * contentWidth) / canvas.width;

                    let position = margin;
                    // Comprobar si el contenido es más alto que una sola página
                    if (imgHeight > (pdfHeight - 2 * margin)) {
                        for (let i = 0; i < Math.ceil(imgHeight / (pdfHeight - 2 * margin)); i++) {
                            const newCanvas = document.createElement('canvas');
                            const newContext = newCanvas.getContext('2d');
                            newCanvas.width = canvas.width;
                            newCanvas.height = Math.min(canvas.height - i * ((pdfHeight - 2 * margin) * canvas.width / contentWidth), ((pdfHeight - 2 * margin) * canvas.width / contentWidth));
                            
                            newContext.drawImage(canvas, 0, i * ((pdfHeight - 2 * margin) * canvas.width / contentWidth), canvas.width, newCanvas.height, 0, 0, newCanvas.width, newCanvas.height);
                            const newImgData = newCanvas.toDataURL('image/png');
                            
                            if (i > 0) {
                                pdf.addPage();
                            }
                            pdf.addImage(newImgData, 'PNG', margin, margin, contentWidth, (newCanvas.height * contentWidth) / newCanvas.width);
                        }
                    } else {
                        pdf.addImage(imgData, 'PNG', margin, position, contentWidth, imgHeight);
                    }
                    
                    pdf.save(`distribucion_aula_${gradeSelect.value}.pdf`);
                    showMessage('PDF exportado con éxito.', 'success');
                    console.log('PDF exportado correctamente.');
                } catch (error) {
                    console.error('Error al exportar PDF:', error);
                    showMessage('Error al exportar el PDF. Por favor, inténtalo de nuevo.', 'error');
                } finally {
                    // Restaurar el estilo original de los inputs y los valores
                    seatInputs.forEach((input, index) => {
                        input.value = originalValues[index];
                        input.style.border = ''; // Eliminar estilo en línea
                        input.style.outline = ''; // Eliminar estilo en línea
                    });
                    classroomDiagram.style.width = originalGridWidth; // Restaurar ancho original
                    document.body.removeChild(classroomContainerForPdf); // Eliminar contenedor temporal
                }
            });

            /**
             * Exporta los nombres de los estudiantes del diagrama del aula a un archivo CSV.
             * Incluye el grado, filas, columnas y una lista numerada de estudiantes.
             */
            exportExcelBtn.addEventListener('click', () => {
                console.log("Botón 'Exportar a Excel (CSV)' clicado!");
                const numRows = parseInt(numRowsInput.value);
                const numCols = parseInt(numColsInput.value);
                const selectedGrade = gradeSelect.value;
                const seatInputs = document.querySelectorAll('.seat-input');
                if (seatInputs.length === 0) {
                    showMessage('No hay un diagrama de aula para exportar a Excel. ¡Crea uno primero!', 'info');
                    return;
                }
                console.log('Generando contenido CSV.');


                let csvContent = `Grado: ${selectedGrade}\n`;
                csvContent += `Total Filas: ${numRows}\nTotal Columnas: ${numCols}\n\n`;
                csvContent += "Numero,Nombre del Estudiante\n";

                let studentCount = 1;
                for (let i = 0; i < seatInputs.length; i++) {
                    let studentName = seatInputs[i].value.trim();
                    
                    if (studentName) {
                        // Manejar comas y comillas dobles en los nombres de los estudiantes para CSV
                        if (studentName.includes(',') || studentName.includes('"')) {
                            studentName = `"${studentName.replace(/"/g, '""')}"`;
                        }
                        csvContent += `${studentCount},${studentName}\n`;
                        studentCount++;
                    }
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `distribucion_aula_${selectedGrade}_enumerada.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showMessage('Archivo Excel (CSV) enumerado exportado con éxito.', 'success');
                    console.log('Archivo CSV exportado correctamente.');
                } else {
                    showMessage('Tu navegador no soporta la descarga de archivos CSV directamente.', 'error');
                    console.error('Error: Navegador no soporta descarga de CSV.');
                }
            });

            /**
             * Carga los nombres de los estudiantes desde un archivo CSV seleccionado y rellena el diagrama del aula.
             * Se espera que el archivo CSV tenga una fila de encabezado y luego "Numero,Nombre del Estudiante".
             * También intenta analizar "Grado:", "Total Filas:", "Total Columnas:" de las primeras líneas.
             */
            loadCsvBtn.addEventListener('click', () => {
                console.log("Botón 'Cargar desde CSV' clicado!");
                const file = csvFileInput.files[0];
                if (!file) {
                    showMessage('Por favor, selecciona un archivo CSV primero.', 'error');
                    console.error('Error: No se ha seleccionado ningún archivo CSV.');
                    return;
                }

                if (!file.name.endsWith('.csv')) {
                    showMessage('Por favor, selecciona un archivo CSV. Puedes exportar tu Excel a CSV primero.', 'error');
                    console.error('Error: Archivo seleccionado no es CSV.');
                    return;
                }
                console.log('Archivo CSV seleccionado:', file.name);


                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvContent = e.target.result;
                        const rows = csvContent.split('\n').map(row => row.trim()).filter(row => row !== '');
                        
                        let loadedGrade = null;
                        let loadedNumRows = null;
                        let loadedNumCols = null;
                        let dataStartIndex = 0;

                        // Analizar la información del encabezado
                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i];
                            if (row.startsWith('Grado:')) {
                                loadedGrade = row.split(':')[1].trim();
                                console.log('CSV Header - Grado:', loadedGrade);
                            } else if (row.startsWith('Total Filas:')) {
                                loadedNumRows = parseInt(row.split(':')[1].trim());
                                console.log('CSV Header - Total Filas:', loadedNumRows);
                            } else if (row.startsWith('Total Columnas:')) {
                                loadedNumCols = parseInt(row.split(':')[1].trim());
                                console.log('CSV Header - Total Columnas:', loadedNumCols);
                            } else if (row.toLowerCase().includes('numero,nombre del estudiante')) {
                                dataStartIndex = i + 1; // Los datos comienzan después de este encabezado
                                console.log('CSV Data Start Index:', dataStartIndex);
                                break;
                            }
                        }
                        
                        const studentNames = [];
                        for (let i = dataStartIndex; i < rows.length; i++) {
                            const row = rows[i];
                            let parts = [];
                            let inQuote = false;
                            let currentPart = '';
                            // Análisis manual de CSV para manejar comas dentro de cadenas entrecomilladas
                            for (let char of row) {
                                if (char === '"') {
                                    inQuote = !inQuote;
                                } else if (char === ',' && !inQuote) {
                                    parts.push(currentPart);
                                    currentPart = '';
                                } else {
                                    currentPart += char;
                                }
                            }
                            parts.push(currentPart); // Añadir la última parte

                            let studentName = parts.slice(1).join(',').trim(); // Unir las partes después del número
                            
                            // Eliminar comillas circundantes y escapar comillas dobles si están presentes
                            if (studentName.startsWith('"') && studentName.endsWith('"')) {
                                studentName = studentName.slice(1, -1).replace(/""/g, '"');
                            }
                            studentNames.push(studentName);
                        }
                        console.log('Nombres de estudiantes cargados desde CSV:', studentNames);


                        // Actualizar los campos de entrada y crear el diseño
                        if (loadedGrade) {
                            gradeSelect.value = loadedGrade;
                        }
                        if (loadedNumRows) {
                            numRowsInput.value = loadedNumRows;
                        }
                        if (loadedNumCols) {
                            numColsInput.value = loadedNumCols;
                        }

                        // Activar la creación del diseño para asegurar que la cuadrícula coincida con las dimensiones del CSV
                        createLayoutBtn.click(); // This will also call showMessage

                        // Rellenar los asientos con los nombres de los estudiantes cargados
                        const seatInputs = document.querySelectorAll('.seat-input');
                        studentNames.forEach((name, index) => {
                            if (seatInputs[index]) {
                                seatInputs[index].value = name;
                            }
                        });
                        showMessage('Archivo CSV cargado y distribución de aula actualizada con éxito.', 'success');
                        console.log('Distribución de aula actualizada desde CSV.');


                    } catch (error) {
                        console.error('Error al procesar el archivo CSV:', error);
                        showMessage('Error al leer el archivo CSV. Asegúrate de que el formato sea correcto y que el archivo esté bien codificado. Detalles: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            });
        });
    </script>
</body>
</html>
